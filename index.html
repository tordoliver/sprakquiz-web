<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spr√•kquiz</title>
  <style>
    :root{
      --bg:#1a1a1a; --bg2:#222; --panel:#2c2c2c; --text:#fff; --muted:#bbb;
      --btn:#f0f0f0; --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .app{min-height:100dvh;display:flex;flex-direction:column}
    header{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.65rem .9rem;background:var(--bg2);position:sticky;top:0;z-index:10}
    header .left{display:flex;align-items:center;gap:.6rem}
    header .right{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap}
    .title{font-weight:800}
    .pill{background:#555;color:#fff;padding:.25rem .6rem;border-radius:999px;font-size:.85rem}
    .btn{appearance:none;border:0;border-radius:12px;background:var(--btn);color:#000;padding:.7rem 1rem;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #666;color:#fff}
    .btn.ok{background:var(--ok);color:#000}
    .btn.warn{background:var(--warn);color:#000}
    .btn.bad{background:var(--bad);color:#fff}
    select,input{width:100%;padding:.7rem .9rem;border-radius:10px;border:1px solid #555;background:#1e1e1e;color:#fff;font-size:1rem}
    .card{width:min(1100px,100%);background:var(--panel);border-radius:16px;padding:1rem;box-shadow:0 8px 28px rgba(0,0,0,.3)}
    .row{display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
    .col{flex:1 1 280px}
    main{flex:1;display:flex;justify-content:center;align-items:center;padding:1rem}
    .levels{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.6rem}
    .level{display:flex;flex-direction:column;gap:.25rem;align-items:center;justify-content:center;padding:.6rem;border-radius:12px;background:#f0f0f0;color:#000;text-align:center;font-weight:700;min-height:82px;cursor:pointer}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #444;padding:.45rem;text-align:left}
    th{background:#3a3a3a}

    /* Modal */
    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:1000}
    .modalCard{background:#2c2c2c;border-radius:14px;width:min(640px,100%);max-height:80dvh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .modalHeader{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;border-bottom:1px solid #444;position:sticky;top:0;background:#2c2c2c;z-index:1}
    .modalBody{padding:.8rem 1rem 1rem}
    .modalClose{appearance:none;border:0;background:#444;color:#fff;border-radius:10px;padding:.35rem .6rem;cursor:pointer}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="left">
      <button id="btnBackTop" class="btn ghost" style="padding:.45rem .7rem;border-radius:10px">‚¨Ö</button>
      <div class="title">üåç <span id="appTitle">Spr√•kquiz</span></div>
      <span class="pill" id="signedInAs">Gjest</span>
    </div>
    <div class="right">
      <select id="uiLangSel" aria-label="UI language">
        <option value="no">Norsk</option>
        <option value="en">English</option>
        <option value="tl">Tagalog</option>
      </select>
      <button class="btn ghost" id="btnLogout">üîÅ <span data-t="logout">Logg ut / bytt</span></button>
    </div>
  </header>

  <main>
    <!-- Login -->
    <div class="card" id="screenLogin">
      <h1 id="loginTitle">Logg inn</h1>
      <div class="row">
        <div class="col">
          <label data-t="username">Brukernavn</label>
          <input id="liUser" autocomplete="username"/>
        </div>
        <div class="col">
          <label data-t="password">Passord</label>
          <input id="liPass" type="password" autocomplete="current-password"/>
        </div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <button class="btn ok" id="doLogin">‚úÖ <span data-t="login">Logg inn</span></button>
        <button class="btn" id="toRegister">üÜï <span data-t="register">Registrer</span></button>
        <button class="btn ghost" id="asGuest">üë§ <span data-t="guest">Gjest</span></button>
      </div>
    </div>

    <!-- Register -->
    <div class="card hidden" id="screenRegister">
      <h1 data-t="register_title">Registrer</h1>
      <div class="row">
        <div class="col">
          <label data-t="username">Brukernavn</label>
          <input id="rgUser" autocomplete="username"/>
        </div>
        <div class="col">
          <label data-t="password">Passord</label>
          <input id="rgPass" type="password" autocomplete="new-password"/>
        </div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <button class="btn ok" id="doRegister">üÜï <span data-t="register">Registrer</span></button>
        <button class="btn ghost" id="backToLogin">‚¨Ö <span data-t="back">Tilbake</span></button>
      </div>
    </div>

    <!-- Hjem -->
    <div class="card hidden" id="screenHome">
      <h1>üåç <span data-t="app_title">Spr√•kquiz</span></h1>
      <div class="row">
        <button class="btn" id="toLevels">üéØ <span data-t="levels">Niv√•er</span></button>
        <button class="btn ghost" id="toSettings">‚öôÔ∏è <span data-t="settings">Innstillinger</span></button>
        <button class="btn ghost" id="toHelp">‚ùì <span data-t="help">Hjelp</span></button>
      </div>
    </div>

    <!-- Velg modus -->
    <div class="card hidden" id="screenPickMode">
      <h2 data-t="choose_mode">Velg modus</h2>
      <div class="row">
        <button class="btn" id="btnModePractice">üß† <span data-t="practice">√òv</span></button>
        <button class="btn" id="btnModeTest">üéØ <span data-t="test">Test</span></button>
      </div>
    </div>

    <!-- Niv√•valg -->
    <div class="card hidden" id="screenLevels">
      <h2 id="levelsTitle">Velg niv√•</h2>
      <div class="levels" id="levelsGrid"></div>
    </div>

    <!-- Quiz -->
    <div class="card hidden" id="screenQuiz">
      <h3 id="quizTitle"></h3>
      <div class="row" style="justify-content:space-between;align-items:center;gap:.6rem">
        <span class="pill" id="dirText"></span>
        <div class="row" style="gap:.5rem">
          <button class="btn ghost hidden" id="btnShowAnswers">üëÅ <span data-t="show_answer">Vis fasit</span></button>
          <span class="pill hidden" id="timerWrap">‚è≥ <span data-t="timer_left">Tid igjen</span>: <span id="timeLeft">15:00</span></span>
          <span class="pill" id="progressPill">0% riktig</span>
        </div>
      </div>

      <div id="prompt" style="font-size:1.25rem;margin:.6rem 0 .35rem"></div>

      <!-- Skriving -->
      <div id="typingWrap">
        <input id="answer" placeholder="Skriv svaret her"/>
      </div>

      <!-- Flervalg -->
      <div id="mcWrap" class="hidden" style="display:grid;grid-template-columns:1fr;gap:.5rem;margin:.4rem 0">
        <div id="mcOptions" class="row" style="gap:.5rem;flex-wrap:wrap"></div>
      </div>

      <div id="resultMsg" style="margin:.4rem 0 .2rem"></div>
      <div id="hintMsg" class="muted" style="min-height:1.2em"></div>

      <div class="row" style="margin-top:.5rem">
        <button class="btn" id="btnCheck"><span data-t="check_answer">Sjekk svar</span></button>
        <button class="btn" id="btnNext" disabled><span data-t="next_question">Neste sp√∏rsm√•l</span></button>
        <button class="btn ghost" id="btnRestart"><span data-t="restart_level">Start niv√•et p√• nytt</span></button>
        <button class="btn ghost" id="btnBackToLevels"><span data-t="pick_new_level">Velg nytt niv√•</span></button>
      </div>
      <div id="finalMsg" style="margin-top:.75rem;font-weight:700"></div>
    </div>

    <!-- Hjelp -->
    <div class="card hidden" id="screenHelp">
      <h2>‚ùì <span data-t="help">Hjelp</span></h2>
      <pre id="helpText" style="white-space:pre-wrap"></pre>
    </div>

    <!-- Innstillinger -->
    <div class="card hidden" id="screenSettings">
      <h2>‚öôÔ∏è <span data-t="settings_title">Innstillinger</span></h2>
      <div class="row">
        <div class="col">
          <label data-t="language">Grensesnittspr√•k</label>
          <select id="selUiLang"></select>
        </div>
        <div class="col">
          <label data-t="i_know">Jeg kan</label>
          <select id="selKnown"></select>
        </div>
        <div class="col">
          <label data-t="i_want_to_learn">Jeg vil l√¶re</label>
          <select id="selLearn"></select>
        </div>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button class="btn ok" id="applySettings"><span data-t="apply">Bruk</span></button>
      </div>
    </div>

    <!-- Modal (Fasit) -->
    <div id="answersModal" class="modalBackdrop hidden" aria-hidden="true">
      <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="answersTitle">
        <div class="modalHeader">
          <strong id="answersTitle">üëÅ <span data-t="show_answer">Vis fasit</span></strong>
          <button class="modalClose" id="answersClose" aria-label="Lukk">‚úï</button>
        </div>
        <div class="modalBody">
          <div class="muted" id="answersLangLine"></div>
          <table style="margin-top:.5rem">
            <thead><tr><th id="thSrc">Kilde</th><th id="thDst">M√•l</th></tr></thead>
            <tbody id="answersTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal (√òvingsm√•te) -->
    <div id="practiceModal" class="modalBackdrop hidden" aria-hidden="true" data-level="">
      <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="practiceTitle">
        <div class="modalHeader">
          <strong id="practiceTitle">üß† <span data-t="choose_practice">Velg √∏vingsm√•te</span></strong>
          <button class="modalClose" id="practiceClose" aria-label="Lukk">‚úï</button>
        </div>
        <div class="modalBody">
          <div class="row" style="gap:.6rem">
            <button class="btn" data-practice="typing">‚å®Ô∏è <span data-t="typing">Skriving</span></button>
            <button class="btn" data-practice="choice">üî¢ <span data-t="multiple_choice">Flervalg</span></button>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
/* ===== i18n / konstanter ===== */
const TEST_TID_SEK = 900;
const LANG_CODES = ["no","en","tl"];
const LANG_NAMES = {no:{no:"norsk",en:"engelsk",tl:"tagalog"},en:{no:"Norwegian",en:"English",tl:"Tagalog"},tl:{no:"Norwegian",en:"Ingles",tl:"Tagalog"}};
const T={
  no:{
    app_title:"Spr√•kquiz",logout:"Logg ut / bytt",username:"Brukernavn",password:"Passord",login:"Logg inn",register:"Registrer",guest:"Gjest",
    register_title:"Registrer",levels:"Niv√•er",settings:"Innstillinger",help:"Hjelp",back:"Tilbake",choose_mode:"Velg modus",practice:"√òv",test:"Test",
    choose_level:"Velg niv√•",choose_level_practice:"Velg niv√• ‚Äì √òv",choose_level_test:"Velg niv√• ‚Äì Test",
    check_answer:"Sjekk svar",next_question:"Neste sp√∏rsm√•l",restart_level:"Start niv√•et p√• nytt",pick_new_level:"Velg nytt niv√•",
    level_finished:"Niv√• ferdig!",timer_left:"Tid igjen",result:o=>`Resultat niv√• ${o.level}: ${o.score}/${o.total} riktige`,
    pct_correct:"% riktig",show_answer:"Vis fasit",hide_answer:"Skjul fasit",src:"Kilde",dst:"M√•l",
    i_know:"Jeg kan",i_want_to_learn:"Jeg vil l√¶re",language:"Grensesnittspr√•k",settings_title:"Innstillinger",apply:"Bruk",
    wrong_try_again:"‚ùå Feil. Pr√∏v igjen!",wrong_again_reveal:ans=>`‚ùå Feil igjen. Riktig: ${ans}`,right:"‚úÖ Riktig!",wrong:"‚ùå Feil.",
    help_text:`‚Ä¢ Velg ¬´Niv√•er¬ª ‚Üí ¬´√òv¬ª eller ¬´Test¬ª.\n‚Ä¢ √òv: hjelpemidler (ordbok, fasit, hint). Test: ingen hjelp + nedtelling.\n‚Ä¢ I Test sp√∏rres hvert ord begge veier (30 sp√∏rsm√•l = 2√ó15).\n‚Ä¢ Full pott i Test l√•ser opp neste niv√•.\n‚Ä¢ ENTER sjekker svaret; ENTER igjen g√•r videre.`,
    enter_user_pass:"Skriv inn brukernavn og passord.",bad_creds:"Feil brukernavn eller passord.",user_exists:"Brukernavn er allerede i bruk.",
    reg_success:"Bruker opprettet. Du kan n√• logge inn.",guest_info:"Du er gjest. Fremdrift lagres ikke.",
    error_same_lang:"Kilde- og m√•l-spr√•k kan ikke v√¶re like.",settings_updated:"Oppdatert",
    choose_practice:"Velg √∏vingsm√•te", typing:"Skriving", multiple_choice:"Flervalg"
  },
  en:{
    app_title:"Language Quiz",logout:"Log out / switch",username:"Username",password:"Password",login:"Log in",register:"Register",guest:"Guest",
    register_title:"Register",levels:"Levels",settings:"Settings",help:"Help",back:"Back",choose_mode:"Choose mode",practice:"Practice",test:"Test",
    choose_level:"Choose level",choose_level_practice:"Choose Level ‚Äì Practice",choose_level_test:"Choose Level ‚Äì Test",
    check_answer:"Check answer",next_question:"Next question",restart_level:"Restart level",pick_new_level:"Pick another level",
    level_finished:"Level finished!",timer_left:"Time left",result:o=>`Result Level ${o.level}: ${o.score}/${o.total} correct`,
    pct_correct:"% correct",show_answer:"Show answers",hide_answer:"Hide answers",src:"Source",dst:"Target",
    i_know:"I know",i_want_to_learn:"I want to learn",language:"Interface language",settings_title:"Settings",apply:"Apply",
    wrong_try_again:"‚ùå Wrong. Try again!",wrong_again_reveal:ans=>`‚ùå Still wrong. Correct: ${ans}`,right:"‚úÖ Correct!",wrong:"‚ùå Wrong.",
    help_text:`‚Ä¢ Choose ‚ÄúLevels‚Äù ‚Üí ‚ÄúPractice‚Äù or ‚ÄúTest‚Äù.\n‚Ä¢ Practice: helpers (word list, answers, hints). Test: no help + countdown.\n‚Ä¢ In Test each word is asked both directions (30 questions = 2√ó15).\n‚Ä¢ A perfect Test unlocks the next level.\n‚Ä¢ ENTER checks the answer; press ENTER again to go next.`,
    enter_user_pass:"Enter username and password.",bad_creds:"Wrong username or password.",user_exists:"Username is already taken.",
    reg_success:"User created. You can log in now.",guest_info:"You are a guest. Progress is not saved.",
    error_same_lang:"Source and target can‚Äôt be the same.",settings_updated:"Updated",
    choose_practice:"Choose practice type", typing:"Typing", multiple_choice:"Multiple choice"
  },
  tl:{
    app_title:"Pagsusulit sa Wika",logout:"Mag-sign out / palitan",username:"Username",password:"Password",login:"Mag-sign in",register:"Magrehistro",guest:"Bisita",
    register_title:"Magrehistro",levels:"Mga Antas",settings:"Mga Setting",help:"Tulong",back:"Bumalik",choose_mode:"Pumili ng mode",practice:"Ehersisyo",test:"Pagsusulit",
    choose_level:"Piliin ang antas",choose_level_practice:"Piliin ang Antas ‚Äì Ehersisyo",choose_level_test:"Piliin ang Antas ‚Äì Pagsusulit",
    check_answer:"Suriin ang sagot",next_question:"Susunod na tanong",restart_level:"Ulitin ang antas",pick_new_level:"Pumili ng ibang antas",
    level_finished:"Tapos na ang antas!",timer_left:"Natitirang oras",result:o=>`Resulta Antas ${o.level}: ${o.score}/${o.total} tama`,
    pct_correct:"% tama",show_answer:"Ipakita ang mga sagot",hide_answer:"Itago ang mga sagot",src:"Pinagmulan",dst:"Patungo",
    i_know:"Alam ko",i_want_to_learn:"Nais kong matutunan",language:"Wika ng UI",settings_title:"Mga Setting",apply:"Ilapat",
    wrong_try_again:"‚ùå Mali. Subukan muli!",wrong_again_reveal:ans=>`‚ùå Mali pa rin. Tama: ${ans}`,right:"‚úÖ Tama!",wrong:"‚ùå Mali.",
    help_text:`‚Ä¢ Piliin ang ‚ÄúMga Antas‚Äù ‚Üí ‚ÄúEhersisyo‚Äù o ‚ÄúPagsusulit‚Äù.\n‚Ä¢ Ehersisyo: may tulong (talaan ng salita, sagot, pahiwatig). Pagsusulit: walang tulong + countdown.\n‚Ä¢ Sa Pagsusulit, parehong direksyon ang tanong sa bawat salita (30 tanong = 2√ó15).\n‚Ä¢ Perpektong iskor sa Pagsusulit ay magbubukas ng susunod na antas.\n‚Ä¢ ENTER para suriin; ENTER muli para magpatuloy.`,
    enter_user_pass:"Ilagay ang username at password.",bad_creds:"Maling username o password.",user_exists:"Nagamit na ang username.",
    reg_success:"Nagawa ang user. Maaari ka nang mag-sign in.",guest_info:"Bisita ka. Hindi ise-save ang progreso.",
    error_same_lang:"Hindi maaaring magkapareho ang pinagmulan at patungo.",settings_updated:"Na-update",
    choose_practice:"Pumili ng paraan ng ehersisyo", typing:"Pagta-type", multiple_choice:"Multiple choice"
  }
};

/* ===== Persistens ===== */
const store={
  get settings(){return JSON.parse(localStorage.getItem('sq_settings')||'{}')},
  set settings(v){localStorage.setItem('sq_settings',JSON.stringify(v))},
  users(){return JSON.parse(localStorage.getItem('sq_users')||'{"users":{}}')},
  saveUsers(d){localStorage.setItem('sq_users',JSON.stringify(d))},
  results(user){return JSON.parse(localStorage.getItem('sq_results_'+user)||'{"oppl√•st":1,"niv√•er":{}}')},
  saveResults(user,data){localStorage.setItem('sq_results_'+user,JSON.stringify(data))}
};

/* ===== App state ===== */
let UI_LANG='no', CURRENT_USER=null;
let LEVELS=[], MODE='ov', CURRENT_LEVEL=1;
let ORD=[], QLIST=[], qi=0, right=0, wrong=0;
let timer={active:false,sec:TEST_TID_SEK};
let currentScreen='screenLogin', navStack=[];
let PRACTICE_TYPE='typing'; // 'typing' | 'choice'

/* ===== Utils ===== */
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
function tr(k,arg){const t=T[UI_LANG][k]; return typeof t==='function'? t(arg):(t||k);}
function applyI18n(){ $('#appTitle').textContent=tr('app_title'); $('[data-t="logout"]').textContent=tr('logout'); $('#loginTitle').textContent=tr('login');
  $$('#screenLogin [data-t], #screenHome [data-t], #screenPickMode [data-t], #screenLevels [data-t], #screenHelp [data-t], #screenSettings [data-t], #screenQuiz [data-t]').forEach(el=>{const k=el.getAttribute('data-t'); const v=T[UI_LANG][k]; if(typeof v==='string') el.textContent=v;});
  $('#helpText').textContent=tr('help_text');
}
function setSignedInLabel(){ $('#signedInAs').textContent = CURRENT_USER? `Innlogget: ${CURRENT_USER}` : 'Gjest'; }
function show(id,{push=true}={}){
  if(push && currentScreen && currentScreen!==id){ navStack.push(currentScreen); }
  ['screenLogin','screenRegister','screenHome','screenPickMode','screenLevels','screenQuiz','screenHelp','screenSettings'].forEach(x=>$('#'+x).classList.add('hidden'));
  $('#'+id).classList.remove('hidden'); currentScreen=id; updateBackState();
}
function updateBackState(){ $('#btnBackTop').disabled = navStack.length===0; }
function goBack(){
  if(!$('#answersModal').classList.contains('hidden')){ closeAnswersModal(); return; }
  if(!$('#practiceModal').classList.contains('hidden')){ closePracticeModal(); return; }
  if(navStack.length===0) return;
  const prev = navStack.pop();
  show(prev,{push:false});
}
function percentCorrect(){const total=Math.max(1,right+wrong); return (right/total)*100;}
function updateProgress(){ $('#progressPill').textContent = `${Math.round(percentCorrect())}${tr('pct_correct')}`;}
function colorForScore(sc){const total=30; const p=Math.max(0,Math.min(100,(sc/total)*100)); const r=Math.round(255*(1-p/100)), g=Math.round(255*(p/100)); return `rgb(${r},${g},0)`;}
async function sha256(str){const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}
function norm(s){ return String(s||'').toLowerCase().trim(); }

/* ===== Niv√•-data ===== */
async function loadLevels(){
  const res=await fetch('./nivaaer_2.json',{cache:'no-store'});
  if(!res.ok){alert('Fant ikke "nivaaer_2.json" i samme mappe som index.html'); return;}
  const raw=await res.json();
  LEVELS = raw.map(n=>({themes:n.themes||{}, items:(n.items||[]).slice(0,15).map(it=>({no:(it.no||'').trim(),en:(it.en||'').trim(),tl:(it.tl||'').trim()}))})).filter(n=>n.items.length===15);
}

/* ===== Brukere ===== */
async function doLogin(){const u=$('#liUser').value.trim(); const p=$('#liPass').value;
  if(!u||!p){alert(tr('enter_user_pass'));return;}
  const db=store.users(); if(!db.users[u]){alert(tr('bad_creds'));return;}
  const h=await sha256(p); if(db.users[u].password_hash!==h){alert(tr('bad_creds'));return;}
  CURRENT_USER=u; setSignedInLabel(); show('screenHome');
}
async function doRegister(){const u=$('#rgUser').value.trim(); const p=$('#rgPass').value;
  if(!u||!p){alert(tr('enter_user_pass'));return;}
  const db=store.users(); if(db.users[u]){alert(tr('user_exists'));return;}
  db.users[u]={password_hash:await sha256(p), created:new Date().toISOString().slice(0,16).replace('T',' ')}; store.saveUsers(db);
  alert(tr('reg_success')); show('screenLogin');
}
function asGuest(){CURRENT_USER=null; setSignedInLabel(); alert(tr('guest_info')); show('screenHome');}
function logout(){CURRENT_USER=null; setSignedInLabel(); show('screenLogin'); navStack=[]; updateBackState();}

/* ===== Innstillinger ===== */
function loadSettingsUI(){
  const s=store.settings||{}; UI_LANG=s.lang||'no'; $('#uiLangSel').value=UI_LANG; applyI18n();
  const selUi=$('#selUiLang'), selK=$('#selKnown'), selL=$('#selLearn'); selUi.innerHTML=''; selK.innerHTML=''; selL.innerHTML='';
  for(const code of ["no","en","tl"]){
    selUi.add(new Option(code,code, code===UI_LANG, code===UI_LANG));
    selK.add(new Option(LANG_NAMES[UI_LANG][code],code,false,(s.known||'no')===code));
    selL.add(new Option(LANG_NAMES[UI_LANG][code],code,false,(s.learn||'tl')===code));
  }
}
function applySettings(){
  const s=store.settings||{}; s.lang=$('#selUiLang').value; s.known=$('#selKnown').value; s.learn=$('#selLearn').value;
  if(s.known===s.learn){alert(tr('error_same_lang'));return;}
  store.settings=s; UI_LANG=s.lang; $('#uiLangSel').value=UI_LANG; applyI18n(); alert(tr('settings_updated'));
}

/* ===== Niv√•valg ===== */
function openPickMode(){ show('screenPickMode'); }
function openLevels(){
  const title = MODE==='ov'? tr('choose_level_practice'): tr('choose_level_test');
  $('#levelsTitle').textContent=title; const grid=$('#levelsGrid'); grid.innerHTML='';
  const res = CURRENT_USER? store.results(CURRENT_USER): {oppl√•st:1, niv√•er:{}};
  for(let i=0;i<LEVELS.length;i++){
    const lvl=i+1, theme=LEVELS[i].themes[UI_LANG]||'', sc=(res.niv√•er[String(lvl)]||{}).poeng;
    const b=document.createElement('button'); b.className='level';
    b.style.background = sc!=null? colorForScore(sc): '#f0f0f0';
    b.innerHTML=`Niv√• ${lvl}${sc!=null? ` (${sc}/30)`:''}${theme? `<br><span class="muted" style="font-weight:500">${theme}</span>`:''}`;
    b.onclick=()=> {
      if(MODE==='ov') openPracticeModal(lvl);
      else startLevel(lvl); // test som f√∏r
    };
    grid.appendChild(b);
  }
  show('screenLevels');
}

/* ===== Quiz ===== */
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];}return a;}

/* buildQuestions for √òv/Test + flervalg-st√∏tte */
function buildQuestions(mode){
  const s=store.settings||{known:'no',learn:'tl'};
  const src=s.known||'no', dst=s.learn||'tl';
  const srcName=LANG_NAMES[UI_LANG][src], dstName=LANG_NAMES[UI_LANG][dst];

  const t=LEVELS[CURRENT_LEVEL-1].items.slice();
  shuffle(t);

  ORD = t.map(it => ({ Source: it[src], Target: it[dst] }));

  const dstToAllSrc = new Map();
  for(const it of t){
    const d = norm(it[dst]);
    const sTerm = norm(it[src]);
    if(!dstToAllSrc.has(d)) dstToAllSrc.set(d, new Set());
    dstToAllSrc.get(d).add(sTerm);
  }

  const answersFor = (questionFrom, expectedTo, dir) => {
    if(dir === 'src2dst'){
      return String(expectedTo).toLowerCase().split('.').map(s=>s.trim()).filter(Boolean);
    }else{
      const key = norm(questionFrom);
      const set = dstToAllSrc.get(key) || new Set();
      return Array.from(set);
    }
  };

  QLIST = [];

  if(mode==='ov'){
    for(const it of ORD){
      if(Math.random()<0.5){
        QLIST.push({ prompt:`Hva er '${it.Source}' p√• ${dstName}?`, answers:answersFor(it.Source, it.Target, 'src2dst'), key:it.Source, dir:'src2dst' });
      }else{
        QLIST.push({ prompt:`Hva er '${it.Target}' p√• ${srcName}?`, answers:answersFor(it.Target, it.Source, 'dst2src'), key:it.Source, dir:'dst2src' });
      }
    }
    shuffle(QLIST);
  }else{
    // Test: begge retninger
    for(const it of ORD){
      QLIST.push({ prompt:`Hva er '${it.Source}' p√• ${dstName}?`, answers:answersFor(it.Source, it.Target, 'src2dst'), key:it.Source, dir:'src2dst' });
      QLIST.push({ prompt:`Hva er '${it.Target}' p√• ${srcName}?`, answers:answersFor(it.Target, it.Source, 'dst2src'), key:it.Source, dir:'dst2src' });
    }
    shuffle(QLIST);
  }

  // Flervalg-alternativer for √∏ving
  if(PRACTICE_TYPE==='choice' && mode==='ov'){
    const srcPool = ORD.map(o=>norm(o.Source));
    const dstPool = ORD.map(o=>norm(o.Target));
    for(const q of QLIST){
      const correct = q.answers[0];
      const pool = (q.dir==='src2dst') ? dstPool : srcPool;
      const picks = new Set([correct]);
      while(picks.size<4){
        const cand = pool[Math.floor(Math.random()*pool.length)];
        if(cand && !picks.has(cand)) picks.add(cand);
      }
      q.choices = shuffle(Array.from(picks));
    }
  }
}

function startLevel(lvl){
  CURRENT_LEVEL=lvl;
  const s=store.settings||{known:'no',learn:'tl'};
  if((s.known||'no')===(s.learn||'tl')){alert(tr('error_same_lang'));return;}
  buildQuestions(MODE); qi=0; right=0; wrong=0; updateProgress();
  $('#finalMsg').textContent=''; $('#resultMsg').textContent=''; $('#hintMsg').textContent='';
  $('#answer').value=''; $('#answer').disabled=false; $('#btnCheck').disabled=false; $('#btnNext').disabled=true;
  $('#btnRestart').disabled=(MODE==='test');
  $('#btnShowAnswers').classList.toggle('hidden', MODE!=='ov'); // kun i √òv

  // toggl UI for √∏vingsm√•te
  $('#typingWrap').classList.toggle('hidden', !(PRACTICE_TYPE==='typing' || MODE==='test'));
  $('#mcWrap').classList.toggle('hidden', !(PRACTICE_TYPE==='choice' && MODE==='ov'));

  const total=QLIST.length; const modeTxt = MODE==='ov'?'√òv':'Test';
  $('#quizTitle').textContent = `Spr√•kquiz ‚Äì Niv√• ${CURRENT_LEVEL} (${total} sp√∏rsm√•l) ‚Äì ${modeTxt}`;
  const known=LANG_NAMES[UI_LANG][s.known||'no'], learn=LANG_NAMES[UI_LANG][s.learn||'tl'];
  $('#dirText').textContent = `${known} ‚Üí ${learn}`;
  timer.active=(MODE==='test'); timer.sec=TEST_TID_SEK; $('#timerWrap').classList.toggle('hidden', MODE!=='test'); if(timer.active) tick();
  nextQuestion(); show('screenQuiz');
}

function renderMC(q){
  const wrap = $('#mcOptions'); wrap.innerHTML='';
  q.choices.forEach(opt=>{
    const btn=document.createElement('button');
    btn.className='btn'; btn.textContent=opt;
    btn.onclick=()=>{
      const ans=opt.toLowerCase();
      const ok=q.answers.includes(ans);
      if(ok){
        $('#resultMsg').textContent=tr('right'); $('#resultMsg').style.color='#8ef28e';
        right++; qi++; updateProgress();
      }else{
        $('#resultMsg').textContent=tr('wrong'); $('#resultMsg').style.color='#ff6b6b';
        wrong++; qi++; updateProgress();
      }
      $('#btnNext').disabled=false;
      $$('#mcOptions .btn').forEach(b=>b.disabled=true);
    };
    wrap.appendChild(btn);
  });
}

function nextQuestion(){
  if(qi>=QLIST.length){showResult(); return;}
  const q=QLIST[qi]; $('#prompt').textContent=q.prompt;
  $('#resultMsg').textContent=''; $('#hintMsg').textContent='';
  $('#btnNext').disabled=true;

  if(MODE==='ov' && PRACTICE_TYPE==='choice'){
    renderMC(q); $('#btnCheck').disabled=true; $('#answer').value=''; $('#answer').disabled=true;
  }else{
    // typing (eller test)
    $('#answer').value=''; $('#answer').disabled=false; $('#btnCheck').disabled=false; $('#answer').focus(); q.tries=0;
  }
}

function checkAnswer(){
  if(MODE==='ov' && PRACTICE_TYPE==='choice') return;
  const q=QLIST[qi]; if($('#btnCheck').disabled) return;
  const ans=$('#answer').value.trim().toLowerCase(); q.tries=(q.tries||0)+1;
  const ok=q.answers.includes(ans);
  if(ok){
    $('#resultMsg').textContent=tr('right'); $('#resultMsg').style.color='#8ef28e';
    right++; $('#answer').disabled=true; $('#btnCheck').disabled=true; $('#btnNext').disabled=false; qi++; updateProgress();
  }else{
    if(MODE==='ov'){
      if(q.tries>=2){
        $('#resultMsg').textContent=tr('wrong_again_reveal')(q.answers.join(', ')); $('#resultMsg').style.color='#ff6b6b';
        wrong++; $('#answer').disabled=true; $('#btnCheck').disabled=true; $('#btnNext').disabled=false; qi++; updateProgress();
      }else{
        const first=(q.answers[0]||'')[0]||'?'; $('#hintMsg').textContent=`Hint: F√∏rste bokstav er '${first}'`;
        $('#resultMsg').textContent=tr('wrong_try_again'); $('#resultMsg').style.color='#ff6b6b';
      }
    }else{
      $('#resultMsg').textContent=tr('wrong'); $('#resultMsg').style.color='#ff6b6b';
      wrong++; $('#answer').disabled=true; $('#btnCheck').disabled=true; $('#btnNext').disabled=false; qi++; updateProgress();
    }
  }
}

function showResult(){
  if(MODE==='test') timer.active=false;
  const total=QLIST.length, score=right;
  $('#finalMsg').textContent=tr('result')({level:CURRENT_LEVEL,score:score,total:total});
  $('#prompt').textContent=tr('level_finished');
  $('#answer').disabled=true; $('#btnCheck').disabled=true; $('#btnNext').disabled=true;
  if(MODE==='test' && CURRENT_USER){
    const res=store.results(CURRENT_USER); const key=String(CURRENT_LEVEL); const prev=(res.niv√•er[key]||{}).poeng||0;
    if(score>prev){res.niv√•er[key]={poeng:score,dato:new Date().toISOString().slice(0,16).replace('T',' ')}; store.saveResults(CURRENT_USER,res);}
    if(score===total && res.oppl√•st===CURRENT_LEVEL){res.oppl√•st=CURRENT_LEVEL+1; store.saveResults(CURRENT_USER,res);}
    $('#btnRestart').disabled=false;
  }
}
function tick(){
  if(!timer.active) return;
  const m=Math.floor(timer.sec/60), s=String(timer.sec%60).padStart(2,'0');
  $('#timeLeft').textContent=`${m}:${s}`;
  if(timer.sec<=0){showResult();return;}
  timer.sec--; setTimeout(tick,1000);
}

/* ===== Fasit-modal ===== */
function openAnswersModal(){
  const s=store.settings||{known:'no',learn:'tl'}; const src=s.known||'no', dst=s.learn||'tl';
  $('#thSrc').textContent=`Kilde: ${LANG_NAMES[UI_LANG][src]}`;
  $('#thDst').textContent=`M√•l: ${LANG_NAMES[UI_LANG][dst]}`;
  $('#answersLangLine').textContent=`${LANG_NAMES[UI_LANG][src]} ‚Üí ${LANG_NAMES[UI_LANG][dst]}`;
  const tb=$('#answersTbody'); tb.innerHTML='';
  for(const it of ORD){ const trEl=document.createElement('tr'); const td1=document.createElement('td'); const td2=document.createElement('td'); td1.textContent=it.Source; td2.textContent=it.Target; trEl.append(td1,td2); tb.appendChild(trEl); }
  $('#answersModal').classList.remove('hidden');
}
function closeAnswersModal(){ $('#answersModal').classList.add('hidden'); }

/* ===== √òvingsm√•te-modal ===== */
function openPracticeModal(lvl){
  const modal = $('#practiceModal');
  modal.dataset.level = String(lvl);                 // lagre niv√•et her
  $('#practiceTitle').innerHTML = `üß† ${tr('choose_practice')} ‚Äì Niv√• ${lvl}`;
  modal.classList.remove('hidden');
}
function closePracticeModal(){
  $('#practiceModal').classList.add('hidden');       // ikke nullstill dataset.level
}
$('#practiceClose').onclick=closePracticeModal;
$('#practiceModal').addEventListener('click',e=>{ if(e.target.id==='practiceModal') closePracticeModal(); });
$$('#practiceModal [data-practice]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    PRACTICE_TYPE = btn.getAttribute('data-practice');
    const lvl = +$('#practiceModal').dataset.level;  // hent riktig niv√•
    closePracticeModal();
    startLevel(lvl);
  });
});

/* ===== Events / navigasjon ===== */
$('#btnBackTop').onclick=goBack;

$('#toRegister').onclick=()=>show('screenRegister');
$('#backToLogin').onclick=()=>show('screenLogin');
$('#asGuest').onclick=asGuest;
$('#doLogin').onclick=doLogin;
$('#doRegister').onclick=doRegister;
$('#btnLogout').onclick=logout;

$('#toLevels').onclick=()=>openPickMode();
$('#btnModePractice').onclick=()=>{MODE='ov'; openLevels();};
$('#btnModeTest').onclick=()=>{MODE='test'; openLevels();};

$('#btnBackToLevels').onclick=()=>openLevels();
$('#btnRestart').onclick=()=>startLevel(CURRENT_LEVEL);
$('#btnCheck').onclick=checkAnswer; $('#btnNext').onclick=nextQuestion;

$('#btnShowAnswers').onclick=openAnswersModal;
$('#answersClose').onclick=closeAnswersModal;
$('#answersModal').addEventListener('click',e=>{ if(e.target.id==='answersModal') closeAnswersModal(); });

$('#toHelp').onclick=()=>{ $('#helpText').textContent=tr('help_text'); show('screenHelp'); };
$('#toSettings').onclick=()=>{loadSettingsUI(); show('screenSettings');};

$('#applySettings').onclick=applySettings;
$('#uiLangSel').onchange=(e)=>{UI_LANG=e.target.value; const s=store.settings||{}; s.lang=UI_LANG; store.settings=s; applyI18n();};

// ENTER i quiz (bare for skriving)
window.addEventListener('keydown',e=>{
  if($('#screenQuiz').classList.contains('hidden')) return;
  if(PRACTICE_TYPE!=='typing' && MODE==='ov') return;
  if(e.key==='Enter'){
    if(!$('#btnCheck').disabled && !$('#answer').disabled){ checkAnswer(); }
    else if(!$('#btnNext').disabled){ nextQuestion(); }
  }
});

/* ===== Oppstart ===== */
(async function init(){
  const s=store.settings||{}; UI_LANG=s.lang||'no'; $('#uiLangSel').value=UI_LANG; applyI18n(); setSignedInLabel();
  await loadLevels(); show('screenLogin',{push:false}); updateBackState();
})();
</script>
</body>
</html>
